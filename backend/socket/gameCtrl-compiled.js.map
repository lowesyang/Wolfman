{"version":3,"sources":["gameCtrl.js"],"names":[],"mappings":"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","file":"gameCtrl-compiled.js","sourcesContent":["var https=require(\"https\");\r\nvar fs=require(\"fs\");\r\nvar server=https.createServer({\r\n    key:fs.readFileSync(\"../ssl/server.key\"),\r\n    cert:fs.readFileSync(\"../ssl/server.crt\")\r\n}).listen(9504);\r\nvar websocket=require(\"ws\").Server;\r\nvar ws=new websocket({server:server});\r\nvar rooms=new Array(100);  //最多1000个房间\r\nvar home=[];    //在首页的玩家列表\r\n\r\n\r\n//--------房间初始化---------\r\nfor(var i=0;i<rooms.length;i++){\r\n    rooms[i]={\r\n        gameStart:0,\r\n        userList:[],    //客户端列表，用于广播\r\n        gameSetting:{},\r\n        gameProcess:{},\r\n        isAutoSet:true,   //是否自动配置，默认为是\r\n        gamerList:new Array(18)    //用于记录座位与对应的玩家名称\r\n    }\r\n}\r\n\r\nws.on('connection',function(conn){\r\n\r\n    conn.on('message',function(message){\r\n        var msgJson=JSON.parse(message);\r\n        var roomID=\"\";\r\n        if(msgJson.res) roomID=msgJson.res.roomID||\"\";\r\n\r\n        if(msgJson.type==\"sync\"){\r\n            conn.userInfo={\r\n                userName:msgJson.res.userName,\r\n                roomID:roomID,\r\n                seatID:-1\r\n            };\r\n            if(rooms[roomID].userList.length>=18) {\r\n                return conn.send(JSON.stringify({\r\n                    type: \"reject\",\r\n                    res:{\r\n                        msg:\"房间已满,请选择其他房间~\"\r\n                    }\r\n                }))\r\n            }\r\n            rooms[roomID].userList.push(conn);\r\n            conn.send(JSON.stringify({\r\n                type: \"sync\",\r\n                res: {\r\n                    gamerList: rooms[roomID].gamerList\r\n                }\r\n            }))\r\n        }\r\n        if(msgJson.type==\"userAction\"){\r\n            var room=rooms[roomID];\r\n            if(conn.userInfo.seatID!=-1 && msgJson.res.seatID!=conn.userInfo.seatID) {\r\n                room.gamerList[conn.userInfo.seatID] = null;\r\n            }\r\n            conn.userInfo.seatID = parseInt(msgJson.res.seatID);\r\n            if(msgJson.res.seatID!=-1) {\r\n                room.gamerList[msgJson.res.seatID] = conn.userInfo.userName;\r\n            }\r\n            for(var i=0;i<room.userList.length;i++){\r\n                if(conn==room.userList[i]) continue;\r\n                room.userList[i].send(JSON.stringify({\r\n                    type:\"userAction\",\r\n                    res:{\r\n                        gamerList:room.gamerList\r\n                    }\r\n                }))\r\n            }\r\n        }\r\n\r\n        if(msgJson.type==\"roomList\"){\r\n            if(home.indexOf(conn)==-1) home.push(conn);\r\n            var rmList=[];\r\n            for(var i=0;i<rooms.length;i++){\r\n                if(rooms[i].userList.length!=0){\r\n                    rmList.push({\r\n                        roomId:i,\r\n                        title:\"狼人游戏\",\r\n                        currNum:rooms[i].userList.length,\r\n                        isStart:rooms[i].gameStart\r\n                    })\r\n                }\r\n            }\r\n            conn.send(JSON.stringify({\r\n                type:\"roomList\",\r\n                res:{\r\n                    roomList:rmList\r\n                }\r\n            }))\r\n        }\r\n\r\n        if(msgJson.type==\"createRoom\"){\r\n            var id;\r\n            for(var i=0;i<rooms.length;i++){\r\n                if(rooms[i].userList.length==0){\r\n                    id=i;\r\n                    break;\r\n                }\r\n            }\r\n            if(id!=rooms.length){\r\n                conn.send(JSON.stringify({\r\n                    type:\"roomOK\",\r\n                    res:{\r\n                        roomID:id\r\n                    }\r\n                }));\r\n            }\r\n            else{\r\n                conn.send(JSON.stringify({\r\n                    type:\"roomFailed\"\r\n                }))\r\n            }\r\n        }\r\n\r\n        if(msgJson.type==\"setting\"){\r\n            var setting=msgJson.res.setting;\r\n            var room=rooms[roomID];\r\n            room.isAutoSet=msgJson.res.isAutoSet;\r\n            room.gameSetting={\r\n                gamerNum:setting.gamerNum,\r\n                roleSetting:setting.roleSetting\r\n            };\r\n            for(var i=0;i<room.userList.length;i++) {\r\n                room.userList[i].send(JSON.stringify({\r\n                    type: \"settingOK\",\r\n                    res: {\r\n                        gamerNum: setting.gamerNum,\r\n                        roles: setting.roleSetting\r\n                    }\r\n                }))\r\n            }\r\n        }\r\n\r\n        //todo 游戏进程控制系统\r\n        if(msgJson.type==\"gameStart\"){\r\n            rooms[roomID].gameStart++;\r\n            if(rooms[roomID].gameSetting.gamerNum==rooms[roomID].gameStart){    //准备人数与玩家人数相同\r\n                var seatInfo=[];\r\n\r\n                rooms[roomID].gameProcess={\r\n                    round:0,\r\n                    period:0,\r\n                    speakers:[],\r\n                    voteList:{},\r\n                    police:-1,\r\n                    dead:[],\r\n                    tools:{}\r\n                }\r\n            }\r\n        }\r\n\r\n        if(msgJson.type==\"game\"){\r\n\r\n        }\r\n    });\r\n\r\n    conn.on('close',function(){\r\n        if(conn.userInfo) {\r\n            var gamerList = rooms[conn.userInfo.roomID].gamerList;\r\n            var userList = rooms[conn.userInfo.roomID].userList;\r\n            gamerList[conn.userInfo.seatID] = null;\r\n            userList.splice(userList.indexOf(conn), 1);\r\n            for (var i = 0; i < userList.length; i++) {\r\n                userList[i].send(JSON.stringify({\r\n                    type: \"userAction\",\r\n                    res: {\r\n                        gamerList: gamerList\r\n                    }\r\n                }))\r\n            }\r\n        }\r\n        var index;\r\n        if((index=home.indexOf(conn))!=-1) home.splice(index,1);\r\n    })\r\n})"]}